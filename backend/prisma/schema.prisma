// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String          @id @default(uuid())
  email        String          @unique
  password_hash String
  role         String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  dataSources  DataSource[]
  alertRules   AlertRule[]
  ansibleConfigs AnsibleConfig[]
  variables    Variable[]
  cdpDiscoveries CdpDiscovery[]
}

model DataSource {
  id          String        @id @default(uuid())
  userId      String?
  name        String
  url         String
  type        String?       // 'influxdb', 'prometheus', etc.
  token       String?
  username    String?
  password    String?
  database    String?
  organization String?
  measurement String?
  isDefault   Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User?         @relation(fields: [userId], references: [id])
  visualizations Visualization[]
  variables   Variable[]
  queries     Query[]
}

model AlertRule {
  id                 String   @id @default(uuid())
  userId             String
  queryId            String?
  threshold          Float
  comparison_operator String
  alertContactPointId String?
  enabled            Boolean  @default(true)
  dataSourceId       String?
  metric_path        String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id])
}

model AnsibleConfig {
  id         String            @id @default(uuid())
  userId     String
  name       String
  config_file String
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  user       User              @relation(fields: [userId], references: [id])
  playbooks  AnsiblePlaybook[]
}

model AnsiblePlaybook {
  id              String       @id @default(uuid())
  ansibleConfigId String
  name            String
  playbook_file   String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  ansibleConfig   AnsibleConfig @relation(fields: [ansibleConfigId], references: [id])
}

model Visualization {
  id            String   @id @default(uuid())
  name          String
  type          String   // "dashboard", "graph", "gauge", "table", etc.
  config        Json?
  queryConfig   Json?
  dataSourceId  String?
  dashboardId   String?  // Reference to parent dashboard (null if this is a dashboard)
  position      Json?    // Position in dashboard (x, y, w, h)
  refreshInterval Int?   @default(10000) // Refresh interval in milliseconds (default 10 seconds)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  dataSource    DataSource? @relation(fields: [dataSourceId], references: [id])
  dashboard     Visualization? @relation("PanelToDashboard", fields: [dashboardId], references: [id])
  panels        Visualization[] @relation("PanelToDashboard")
  queries       Query[]
  variables     DashboardVariable[]
}

model Variable {
  id          String   @id @default(uuid())
  name        String
  label       String?
  type        String   // query, custom, interval, etc.
  query       String?
  options     Json?    // Possible values
  current     String?  // Current selected value
  dataSourceId String?
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])
  dataSource  DataSource? @relation(fields: [dataSourceId], references: [id])
}

model Query {
  id          String    @id @default(uuid())
  refId       String    // A, B, C, etc.
  query       String    // The actual query string
  visualization Visualization @relation(fields: [visualizationId], references: [id], onDelete: Cascade)
  visualizationId String
  dataSource  DataSource @relation(fields: [dataSourceId], references: [id])
  dataSourceId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model DashboardVariable {
  id          String    @id @default(uuid())
  name        String
  label       String?
  type        String    // query, custom, textbox, constant
  query       String?
  value       String[]
  dashboard   Visualization @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  dashboardId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

/// CDP Discovery Models
enum DiscoveryStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model CdpDiscovery {
  id           String           @id @default(uuid())
  name         String?
  seedIps      Json
  status       DiscoveryStatus  @default(PENDING)
  isSaved      Boolean          @default(false)
  options      Json?
  graph        Json?
  startedAt    DateTime?
  finishedAt   DateTime?
  errorMessage String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  userId       String?
  user         User?            @relation(fields: [userId], references: [id])
  nodes        CdpNode[]
  links        CdpLink[]

  @@index([status])
  @@index([isSaved])
}

model CdpNode {
  id         String       @id @default(uuid())
  discoveryId String
  hostname   String?
  mgmtIp     String?
  vendor     String?
  platform   String?
  model      String?
  osVersion  String?
  site       String?
  raw        Json?
  discovery  CdpDiscovery @relation(fields: [discoveryId], references: [id], onDelete: Cascade)
  interfaces CdpInterface[]
  srcLinks   CdpLink[]    @relation("SrcNode")
  dstLinks   CdpLink[]    @relation("DstNode")

  @@index([discoveryId])
  @@index([mgmtIp])
}

model CdpInterface {
  id          String  @id @default(uuid())
  nodeId      String
  name        String
  description String?
  mac         String?
  vlan        String?
  speed       Int?
  raw         Json?
  node        CdpNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@index([nodeId])
}

model CdpLink {
  id              String      @id @default(uuid())
  discoveryId     String
  srcNodeId       String
  dstNodeId       String
  srcInterfaceId  String?
  dstInterfaceId  String?
  linkType        String?     @default("cdp")
  speed           Int?
  raw             Json?
  discovery       CdpDiscovery @relation(fields: [discoveryId], references: [id], onDelete: Cascade)
  srcNode         CdpNode     @relation("SrcNode", fields: [srcNodeId], references: [id], onDelete: Cascade)
  dstNode         CdpNode     @relation("DstNode", fields: [dstNodeId], references: [id], onDelete: Cascade)

  @@index([discoveryId])
  @@index([srcNodeId])
  @@index([dstNodeId])
}