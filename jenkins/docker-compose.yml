version: '3.8'

# Jenkins CI/CD for MSTI Automation
# This runs on VPS and polls GitHub for changes
# VPS has full internet access (inbound/outbound)

services:
  jenkins:
    build:
      context: .
      dockerfile: Dockerfile
    image: msti-jenkins:latest
    container_name: msti-jenkins
    restart: unless-stopped
    user: root  # Required for Docker socket access
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock  # Access host Docker
      - /usr/bin/docker:/usr/bin/docker            # Docker CLI
      - /opt/msti-automation:/opt/msti-automation:rw  # Access deployment files
      # Mount host CA certificates to fix SSL issues
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
    environment:
      # Enable setup wizard for first-time setup
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=true -Djavax.net.ssl.trustStore=/opt/java/openjdk/lib/security/cacerts -Djavax.net.ssl.trustStorePassword=changeit -Djavax.net.ssl.trustStoreType=JKS
      - TZ=Asia/Jakarta
      - JENKINS_OPTS=--httpPort=8080
      # Ensure Java trusts system certificates
      - CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt
    # Use host network mode to ensure internet access works properly
    network_mode: host
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/login"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  jenkins_home:
    name: msti-jenkins-data
